<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1"/>
	<title>Shopping List</title>
	<link rel="icon" type="image/png" href="data/favicon.png"/>
	<style>
		body {
			font-size:4vw;
		}
		input {
			font-size:100%;
		}
		button {
			font-size:80%;
			white-space:nowrap;
		}
		#Receipt {
 			width:100%;
			margin:1% 0;
		}
		input.PsFill { border-width:0 0 2px 0;text-align:center; }
	</style>
	<script>
	var Main={
		TWDRate:{
			EUR:34,
			CZK:1.5,
			DKR:5,
			SER:3
		},
		BlankReceipt:{
			"Unit":"EUR","RNO":"current",
			"Total":0,"TotalTD":0,"Items":[]
		},
		redraw:function(){
			let self=this;
			self.Form=new Piers.Widget.Form(Piers.DOM.select("#Receipt",document.body));
			self.Receipt.Total=self.Receipt.Items.reduce(function(r,v){
				return r+parseFloat(v.LD);
			},0);
			self.Receipt.TotalTD=Math.floor(100*self.Receipt.Total*self.TWDRate[self.Receipt.Unit])/100;
			self.Receipt.Total=Math.floor(100*self.Receipt.Total)/100;
			self.Form.set(
				self.Receipt
			).then(function(){
				self.DB.request("save:"+self.Receipt.RNO,self.Receipt).then(Piers.nf,Piers.nf);
			},Piers.nf);
		},
		calc:function(fm){
			fm=new Piers.Widget.Form(fm);
			let d=fm.get();
			d.LD=parseFloat(d.LD);
			d.TD=Math.floor(100*d.LD*this.TWDRate[this.Receipt.Unit])/100;
			fm.set(d).then(Piers.nf,Piers.nf);
		},
		add:function(fm){
			let c=document.getElementById("Calc"),
				d=c.Widget.get(),
				w=document.getElementById("Receipt").Widget;
			if(!d.LD) return;
			c.reset(); c.Widget.set({"I":"","TD":0}).then(Piers.nf,Piers.nf);
			d.LD=parseFloat(d.LD);
			d.TD=Math.floor(100*d.LD*this.TWDRate[this.Receipt.Unit])/100;
			if(!d.I) d.I=(new Date).getTime().toString(36);
			if(!d.T) d.T="未設定";
			this.Receipt.Items=this.Receipt.Items.filter(function(v){
				console.log(v,v.I,d.I);
				return v.I!==d.I;
			});
			this.Receipt.Items.unshift(d);
			this.redraw();
		},
		edit:function(e){
			let w=Piers.DOM.select('[an="Items:List"]',document.getElementById("Receipt")).Widget;
			console.log(w);
			document.getElementById("Calc").Widget.set(w.getData(e)).then(Piers.nf,Piers.nf);
		},
		remove:function(e){
			let w=Piers.DOM.select('[an="Items:List"]',document.getElementById("Receipt")).Widget;
			w.removeItem(e);
			this.Receipt.Items=w.get();
			this.redraw();
		},
		submit:function(){
			if(this.Receipt.Items.length<=0) return alert("No record");
			this.Receipt=JSON.parse(JSON.stringify(this.BlankReceipt));
			this.DB.request(
				"save:"+(new Date()).getTime().toString(36),
				JSON.stringify(this.Receipt)
			);
			this.redraw();
		},
		onload:function(){
			let self=this;
			new Piers.Widget.Form(document.getElementById("Calc"));
			new Piers.Widget.Form(document.getElementById("Receipt"));
			self.DB=new Piers.Session.LocalHome();
			self.DB.authenticate("guest","itsme").then(function(){
				self.DB.request("load:current",JSON.stringify(self.BlankReceipt))
				.then(function(doc){
					self.Receipt=JSON.parse(doc);
					self.redraw();
				},console.log);
			}, function(x){
				alert("Login failed as "+x.user);
			});
		}
	};
	</script>
	<!--script PierEntrance="Main.onload" PierXMods="Widget" src="http://www.piersforge.com/js/init.js"></script-->
	<script PierEntrance="Main.onload" PierXMods="Widget,Session" src="js/init.js"></script>
</head>
<body style="text-align:center;">
	<div>
		<form id="Calc" onsubmit="return false;" onchange="Main.calc(this)">
			<div class="PsSpanRow">
				<input type="hidden" an="I:Value"/>
				<input class="PsFill" type="text" an="T:Value"/>
				EUR: <input class="PsFill" type="number" value="0" step="0.01" an="LD:Value"/>
				TWD: <span an="TD:text"></span>
			</div>
		</form>
	</div>

	<div id="Receipt">
		<div class="PsSpanRow">
			<span an="FN:text"></span>
		</div>
		<table border="1" cellspacing="0" width="100%" align="center">
			<thead><tr>
				<th>名稱</th>
				<th an="Unit:Text"></th>
				<th>TWD</th>
				<th width="1px"><button onclick="Main.add()">新增</button></th>
			</tr></thead>
			<tbody an="Items:List"><tr>
				<td an="T:Text"></td>
				<td><button onclick="Main.edit(this)" an="LD:Text"></button></td>
				<td an="TD:Text"></td>
				<td><button onclick="Main.remove(this)">刪除</button></td>
			</tr></tbody>
			<tbody><tr>
				<th>總計</th>
				<td an="Total:Text"></td>
				<td an="TotalTD:Text"></td>
				<td><button onclick="Main.submit()">結帳</button></td>
			</tr></tbody>
		</table>
	</div>

</body>
</html>
